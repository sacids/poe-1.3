{% extends 'backend/base.html' %}
{% load poe_tags %}

{% block navarea %}

{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-12">
            <table id="travellers_table" class="display" style="width:100%">
                <thead>
                <tr>
                    <th width="20%">Traveller Name</th>
                    <th width="12%">Nationality</th>
                    <th width="12%">ID Number</th>
                    <th width="8%">Age</th>
                    <th width="8%">Sex</th>
                    <th width="15%">Point of Entry</th>
                    <th width="15%">Transport No</th>
                    <th width="15%">Origin Country</th>
                    <th width="10%">Temp</th>
                </tr>
                </thead>
                <tbody>
                {% for traveller in travellers %}
                    <tr id="row_{{ traveller.id }}" {% ifnotequal '0' traveller.disease_to_screen %} class="screen"
                    {% endifnotequal %} data='{ 
                        "Sex":"{{ traveller.sex }}",
                        "Age category":"{{ traveller.age_category }}",
                        "Age":"{{ traveller.age }}",
                        "Nationality":"{{ traveller.nationality.title }}",
                        "Identification Type":"{{ traveller.id_type }}",
                        "Identification Number":"{{ traveller.id_number }}",
                        "Occupation":"{{ traveller.employment }}",
                        "Other Occupation":"{{ traveller.other_employment }}",
                        "Mode of transport":"{{ traveller.mode_of_transport }}",
                        "Name of transport":"{{ traveller.name_of_transport }}",
                        "Seat Number":"{{ traveller.seat_no }}",
                        "Visiting purpose":"{{ traveller.visiting_purpose }}",
                        "Other Purpose":"{{ traveller.other_purpose }}",
                        "Duration of Stay":"{{ traveller.duration_of_stay }}",
                        "Physical Address":"{{ traveller.physical_address|remove_newlines }}",
                        "Region":"{{ traveller.region.title }}",
                        "District":"{{ traveller.district_id.title }}",
                        "Street/Ward":"{{ traveller.street_or_ward|remove_newlines }}",
                        "Phone":"{{ traveller.phone }}",
                        "Email":"{{ traveller.email }}"
                        }'
                        symptoms='[
                                {% for symptom in traveller.symptoms.all %}{{ symptom.id }}{% if not forloop.last %},{% endif %}{% endfor %}]'
                        v_areas='{ {% for area in traveller.visited_area.all %} "{{ area.id }}":{ "location_visited":"{{ area.location_visited }}","date":"{{ area.date }}","days":"{{ area.days }}","location":"{{ area.location.title }}" } {% if not forloop.last %},{% endif %} {% endfor %} }'>
                        <td class="full_name">{{ traveller.surname }} {{ traveller.other_names }}</td>
                        <td class="nationality">{{ traveller.nationality.title }}</td>
                        <td class="id_number">{{ traveller.id_number }}</td>
                        <td class="id_age">{{ traveller.age }}
                            {% if traveller.age_category == 'above' %}
                                years
                            {% else %}
                                month
                            {% endif %}
                        </td>
                        <td class="sex">{{ traveller.sex }}</td>
                        <td class="point_of_entry">{{ traveller.point_of_entry.code }}</td>
                        <td class="name_of_transport">{{ traveller.name_of_transport }}</td>
                        <td class="location_origin_title">{{ traveller.location_origin.title }}</td>
                        <td class="temp">{{ traveller.temp }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div id="traveller_data">
        <div id="close_traveller_data"><i class="fa fa-times text-danger"></i></div>
        <div class="clearfix">
            <div class="float-left">
                <div style="font-size: 1.2em" id="full_name" class="font-weight-bold"></div>
                <div id="id_number" style="font-size: 0.8em"></div>
                <div id="name_of_transport" style="font-size: 0.8em"></div>
            </div>
            <div class="float-right mx-2">
                <input type="hidden" id="travellers_id" name="id">
                <button type="button" class="btn btn-info btn-block" id="set_temp"
                        style="font-size: 1.7em;margin-top:5px;margin-right:30px;">SET
                </button>
            </div>
            <div class="float-right" style="font-size: 2.7em">
                <select class="" id="temp_b">
                    {% for i in temp_b %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="float-right" style="font-size: 2.7em">.</div>
            <div class="float-right" style="font-size: 2.7em">
                <select class="" id="temp_a">
                    {% for i in temp_a %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!--tabs-->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#check">Primary Screening</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#info">Traveller Info</a>
            </li>
        </ul>
        <div class="tab-content">
            <div id="check" class="tab-pane fade in active show py-3">
                <h5>Symptoms</h5>
                <div class="border-bottom pb-3">
                    <form id="form_edit_traveller_symptoms">
                        <div class="row">
                            {% for s in symptoms %}
                                <div class="col-6"><label><input type="checkbox" id="chk_symptom_{{ s.id }}"
                                                                 value="{{ s.id }}"
                                                                 name="symptoms[]" disabled> {{ s.title }} </label>
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" value="" name="traveller_id" id="traveller_id">
                        <input class="btn btn-primary" type="submit" value="Edit" id="edit_traveller_symptoms">
                    </form>
                </div>
                <h5 class="mt-2">Travel History</h5>
                <div id="travel_history">
                </div>
            </div>
            <div id="info" class="tab-pane fade">

            </div>
        </div>
    </div>

{% endblock %}

{% block script %}
    <script type="text/javascript" language="javascript" class="init">
        $(document).ready(function () {


            oTable = $('#travellers_table').DataTable({
                "columnDefs": [
                    {
                        "targets": [4],
                        "visible": false,
                        "searchable": false
                    }
                ],
                "paging": false,
                "info": false
            });

            $('#site_search').keyup(function () {
                oTable.search($(this).val()).draw();
            })

            $(document).on('click', '#travellers_table tbody tr', function (event) {
                // hide search
                $(".site-search").removeClass('search-visible');

                var row_id = $(this).attr('id');
                var id = row_id.substring(4);

                $('#full_name').html($('#' + row_id + ' .full_name').html());
                $('#id_number').html($('#' + row_id + ' .id_number').html());
                $('#location_origin_title').html($('#' + row_id + ' .location_origin_title').text());
                $('#name_of_transport').html($('#' + row_id + ' .name_of_transport').text());

                var l = $('#' + row_id + ' .location_origin_title').clone();
                l.show();
                var l_text = l.html();
                l.remove();
                $('#location_origin_title').html(l_text);

                var symptoms = $(this).attr('symptoms');
                var v_areas = $(this).attr('v_areas');
                var data = $(this).attr('data');

                // Manage Sysmptoms
                // console.log(symptoms);
                var arr = jQuery.parseJSON(symptoms);
                // unselect all checkboxes in form
                console.log('removing checked');
                $('#form_edit_traveller_symptoms input:checkbox').prop('checked', false)
                for (var item of arr) {
                    $('#chk_symptom_' + item).prop('checked', true)
                }
                $('#traveller_id').val(id);

                // Manage travel history
                var obj = jQuery.parseJSON(v_areas);
                // empty travel history div
                $('#travel_history').html('');
                var tmp = "<table class='table table-bordered' width='80%'><thead><tr><td>Country</td><td>Area</td><td>Date</td><td>Days</td></tr></thead><tbody>"
                $.each(obj, function (key, value) {
                    // set specific sysmptoms only
                    tmp += '<tr><td>' + value.location + '</td><td>' + value.location_visited + '</td><td>' + value.date + '</td><td>' + value.days + '</td></tr>';
                });
                tmp += "</tbody></table>"
                $('#travel_history').html(tmp);

                // Manage travell info
                var obj = jQuery.parseJSON(data);
                // empty travel history div
                $('#info').html('');
                var tmp = "<table class='table table-bordered' width='80%'><tbody>"
                for (x in obj) {
                    tmp += '<tr><td width="40%"><span class="font-weight-bold">' + x + '</span></td><td>' + obj[x] + '</td></tr>';
                }
                tmp += "</tbody></table>"
                $('#info').html(tmp);

                // set temperature
                var temp = $('#' + row_id + ' .temp').html();
                var temp_b = temp.substring(3, 4);
                var temp_a = temp.substring(0, 2);
                $('#temp_a').val(temp_a);
                $('#temp_b').val(temp_b);

                // set id
                $('#travellers_id').val(id);

                // show travellers data
                $('#traveller_data').animate({
                    marginRight: '0px'
                }, 500);


            });

            $(document).on('click', '#close_traveller_data', function (e) {

                $('#traveller_data').animate({
                    marginRight: '-50%'
                }, 500);
            });


            $(document).on('click', '#edit_traveller_symptoms', function (e) {

                e.preventDefault();

                var id = $(this).attr('id');
                var btn = $(this).val();
                var tid = $('#traveller_id').val();
                if (btn == 'Edit') {
                    // enable fields
                    $('#form_' + id + ' input').prop('disabled', false);
                    $('#' + id).val('Update');
                    return
                }

                // get checked symptoms
                var symptoms = [];
                $.each($("input[name='symptoms[]']:checked"), function () {
                    symptoms.push($(this).val());
                });
                tmp = '[' + symptoms.join(",") + ']';
                $('#row_' + tid).attr('symptoms', tmp);


                var data = $('#form_' + id).serialize()
                // submit data
                var jqXHR = $.ajax({
                    type: "GET",
                    url: window.location.origin + '/screen/update_symptoms',
                    data: data,
                }).done(function (data) {
                    if (data) {
                        // success show
                        // disable fields
                        //alert(id)
                        $('#form_' + id + ' input:checkbox').prop('disabled', true);
                        $('#' + id).val('Edit');

                        if (data == 2) $('#row_' + tid).addClass('screen');
                        if (data == 1) $('#row_' + tid).removeClass('screen');
                        return
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    alert(textStatus);
                }).always(function () {

                });
            });

            $(document).on('click', '#set_temp', function (event) {

                var temp = $('#temp_a').val() + '.' + $('#temp_b').val();
                var id = $('#travellers_id').val();
                var url = window.location.origin + '/screen/set_temp?id=' + id + '&temp=' + temp;

                var jqXHR = $.ajax({
                    type: "GET",
                    url: url
                }).done(function (data) {
                    //alert(data)
                    if (data > 0) $('#row_' + id + ' .temp').html(temp);
                    if (data == 2) $('#row_' + id).addClass('screen');
                    if (data == 1) $('#row_' + id).removeClass('screen');

                }).fail(function (jqXHR, textStatus, errorThrown) {
                    alert('Failed to update temp');
                    if (console && console.log) {
                        console.log("Loading Ajax: " + textStatus + ", " + errorThrown);
                    }

                }).always(function () {

                });

            });
        });
    </script>
{% endblock %}